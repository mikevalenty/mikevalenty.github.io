
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mike Valenty</title>
  <meta name="author" content="Mike Valenty">

  
  <meta name="description" content="What is a Happy Number? Starting with any positive integer, replace the number by the sum of the squares of its digits, and repeat the process until &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.mikevalenty.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Mike Valenty" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-2314490-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">&gt; Mike Valenty</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="www.mikevalenty.com">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/about-mike-valenty">Contact Me</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/scala-solution-to-finding-happy-numbers/">Scala Solution to Finding Happy Numbers</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-05-03T10:45:00-07:00'><span class='date'><span class='date-month'>May</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>10:45 am</span></time>
        
           | <a href="/scala-solution-to-finding-happy-numbers/#disqus_thread"
             data-disqus-identifier="http://www.mikevalenty.com/scala-solution-to-finding-happy-numbers/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>What is a Happy Number?</p>

<blockquote><p>Starting with any positive integer, replace the number by the sum of the squares of its digits, and repeat the process until the number equals 1 (where it will stay), or it loops endlessly in a cycle which does not include 1.</p>

<p><a href="http://en.wikipedia.org/wiki/Happy_number">http://en.wikipedia.org/wiki/Happy_number</a></p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">JUnitRunner</span><span class="o">])</span>
</span><span class='line'><span class="k">class</span> <span class="nc">HappyTests</span> <span class="k">extends</span> <span class="nc">FunSuite</span> <span class="k">with</span> <span class="nc">ShouldMatchers</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">happy</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="n">sumOfSquares</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">def</span> <span class="n">digits</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="k">if</span> <span class="o">(</span><span class="n">x</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">)</span> <span class="nc">Seq</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="k">else</span> <span class="n">digits</span><span class="o">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">10</span><span class="o">)</span> <span class="o">:+</span> <span class="n">x</span> <span class="o">%</span> <span class="mi">10</span>
</span><span class='line'>      <span class="k">def</span> <span class="n">squared</span><span class="o">(</span><span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span>
</span><span class='line'>      <span class="n">digits</span><span class="o">(</span><span class="n">x</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">squared</span><span class="o">).</span><span class="n">sum</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="n">loop</span><span class="o">(</span><span class="n">seen</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">Int</span><span class="o">],</span> <span class="n">x</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">x</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="mi">1</span> <span class="k">=&gt;</span> <span class="kc">true</span>
</span><span class='line'>        <span class="k">case</span> <span class="k">_</span> <span class="k">if</span> <span class="n">seen</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">false</span>
</span><span class='line'>        <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">loop</span><span class="o">(</span><span class="n">seen</span> <span class="o">+</span> <span class="n">x</span><span class="o">,</span> <span class="n">sumOfSquares</span><span class="o">(</span><span class="n">x</span><span class="o">))</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">loop</span><span class="o">(</span><span class="nc">Set</span><span class="o">(),</span> <span class="n">x</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">test</span><span class="o">(</span><span class="s">&quot;happy numbers&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">actual</span> <span class="k">=</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">50</span> <span class="n">filter</span> <span class="n">happy</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">expected</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">7</span><span class="o">,</span> <span class="mi">10</span><span class="o">,</span> <span class="mi">13</span><span class="o">,</span> <span class="mi">19</span><span class="o">,</span> <span class="mi">23</span><span class="o">,</span> <span class="mi">28</span><span class="o">,</span> <span class="mi">31</span><span class="o">,</span> <span class="mi">32</span><span class="o">,</span> <span class="mi">44</span><span class="o">,</span> <span class="mi">49</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">actual</span> <span class="n">should</span> <span class="n">equal</span><span class="o">(</span><span class="n">expected</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/scala-solution-to-cheryls-birthday-problem/">Scala Solution to Cheryl&#8217;s Birthday Problem</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-04-19T14:54:00-07:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>19</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>2:54 pm</span></time>
        
           | <a href="/scala-solution-to-cheryls-birthday-problem/#disqus_thread"
             data-disqus-identifier="http://www.mikevalenty.com/scala-solution-to-cheryls-birthday-problem/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I ran across a <a href="https://github.com/mad4j/puzzles/blob/master/src/dolmisani/puzzles/CherylBirthday.java">Java 8 solution</a> to <a href="http://www.nytimes.com/2015/04/15/science/a-math-problem-from-singapore-goes-viral-when-is-cheryls-birthday.html">Cheryl&rsquo;s birthday problem</a> and just had to write a Scala version since this is one of those problems the language was made for. Also, I&rsquo;ve been on the Java train for a few months and this was a good excuse to brush off the dust and work on my Scala chops.</p>

<h4>Cheryl&rsquo;s Birthday Problem</h4>

<blockquote><p>Albert and Bernard just become friends with Cheryl, and they want to know when her birthday is. Cheryl gives them a list of 10 possible dates.</p></blockquote>

<pre><code>May 15, May 16, May 19
June 17, June 18
July 14, July 16
August 14, August 15, August 17
</code></pre>

<blockquote><p>Cheryl then tells Albert and Bernard separately the month and the day of her birthday respectively.</p></blockquote>

<p><strong>Albert:</strong> I don’t know when Cheryl&rsquo;s birthday is, but I know that Bernard does not know too.</p>

<p><strong>Bernard:</strong> At first I don&rsquo;t know when Cheryl&rsquo;s birthday is, but I know now.</p>

<p><strong>Albert:</strong> Then I also know when Cheryl&rsquo;s birthday is.</p>

<p>So when is Cheryl’s birthday?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">JUnitRunner</span><span class="o">])</span>
</span><span class='line'><span class="k">class</span> <span class="nc">BirthdayProblem</span> <span class="k">extends</span> <span class="nc">FunSuite</span> <span class="k">with</span> <span class="nc">ShouldMatchers</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">case</span> <span class="k">class</span> <span class="nc">Birthday</span><span class="o">(</span><span class="n">month</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">day</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">object</span> <span class="nc">Birthday</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Birthday</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;-&quot;</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="nc">Array</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">d</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Birthday</span><span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">d</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">birthdays</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Birthday</span><span class="o">]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
</span><span class='line'>    <span class="s">&quot;5-15&quot;</span><span class="o">,</span> <span class="s">&quot;5-16&quot;</span><span class="o">,</span> <span class="s">&quot;5-19&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;6-17&quot;</span><span class="o">,</span> <span class="s">&quot;6-18&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;7-14&quot;</span><span class="o">,</span> <span class="s">&quot;7-16&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;8-14&quot;</span><span class="o">,</span> <span class="s">&quot;8-15&quot;</span><span class="o">,</span> <span class="s">&quot;8-17&quot;</span>
</span><span class='line'>  <span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="nc">Birthday</span><span class="o">.</span><span class="n">apply</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">uniqueBy</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">K</span><span class="o">](</span><span class="n">fn</span><span class="k">:</span> <span class="o">(</span><span class="kt">A</span><span class="o">)</span> <span class="o">=&gt;</span> <span class="n">K</span><span class="o">)(</span><span class="n">b</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">groupSizeIs</span><span class="o">(</span><span class="n">size</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="n">x</span><span class="k">:</span> <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="kt">List</span><span class="o">[</span><span class="k">_</span><span class="o">]))</span> <span class="k">=</span> <span class="n">x</span><span class="o">.</span><span class="n">_2</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">size</span>
</span><span class='line'>    <span class="n">b</span><span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="n">fn</span><span class="o">).</span><span class="n">filter</span><span class="o">(</span><span class="n">groupSizeIs</span><span class="o">(</span><span class="mi">1</span><span class="o">)).</span><span class="n">flatMap</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_2</span><span class="o">).</span><span class="n">toList</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">uniqueByDay</span><span class="k">:</span> <span class="o">(</span><span class="kt">List</span><span class="o">[</span><span class="kt">Birthday</span><span class="o">])</span> <span class="k">=&gt;</span> <span class="nc">List</span><span class="o">[</span><span class="kt">Birthday</span><span class="o">]</span> <span class="k">=</span> <span class="n">uniqueBy</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">day</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">uniqueByMonth</span><span class="k">:</span> <span class="o">(</span><span class="kt">List</span><span class="o">[</span><span class="kt">Birthday</span><span class="o">])</span> <span class="k">=&gt;</span> <span class="nc">List</span><span class="o">[</span><span class="kt">Birthday</span><span class="o">]</span> <span class="k">=</span> <span class="n">uniqueBy</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">month</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Albert tells us that Bernard doesn&#39;t know the answer, so we</span>
</span><span class='line'>  <span class="c1">// know the answer must be in a month that does not contain a</span>
</span><span class='line'>  <span class="c1">// birthday with a unique day.</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">clue1</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Birthday</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">monthsWithUniqueDay</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">uniqueByDay</span><span class="o">(</span><span class="n">birthdays</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">month</span><span class="o">).</span><span class="n">toSet</span>
</span><span class='line'>    <span class="n">birthdays</span><span class="o">.</span><span class="n">filterNot</span><span class="o">(</span><span class="n">b</span> <span class="k">=&gt;</span> <span class="n">monthsWithUniqueDay</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="n">b</span><span class="o">.</span><span class="n">month</span><span class="o">))</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Since Bernard now knows the answer, that tells us that the</span>
</span><span class='line'>  <span class="c1">// day must be unique among the remaining birthdays.</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">clue2</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Birthday</span><span class="o">]</span> <span class="k">=</span> <span class="n">uniqueByDay</span><span class="o">(</span><span class="n">clue1</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Since Albert now knows the answer, that tells us the answer</span>
</span><span class='line'>  <span class="c1">// has to be unique by month.</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">clue3</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Birthday</span><span class="o">]</span> <span class="k">=</span> <span class="n">uniqueByMonth</span><span class="o">(</span><span class="n">clue2</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// The only remaining birthday is the answer.</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">answer</span> <span class="k">=</span> <span class="n">clue3</span><span class="o">.</span><span class="n">head</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">test</span><span class="o">(</span><span class="s">&quot;Cheryl&#39;s birthday&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">answer</span> <span class="n">should</span> <span class="n">equal</span><span class="o">(</span><span class="nc">Birthday</span><span class="o">(</span><span class="s">&quot;xx-xx&quot;</span><span class="o">))</span> <span class="c1">// REDACTED</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yay.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/unit-testing-scalding-jobs/">Unit Testing Scalding Jobs</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-03-15T15:27:00-07:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>15</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>3:27 pm</span></time>
        
           | <a href="/unit-testing-scalding-jobs/#disqus_thread"
             data-disqus-identifier="http://www.mikevalenty.com/unit-testing-scalding-jobs/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://github.com/twitter/scalding">Scalding</a> is a powerful framework for writing complex data processing applications on Apache Hadoop. It&rsquo;s concise and expressive - almost to a fault. It&rsquo;s dangerously easy to pack gobs of subtle business logic into just a few lines of code. If you&rsquo;re writing real data processing applications and not just ad-hoc reports, unit testing is a must. However tests can get unwieldy to manage as job complexity grows and the arity of data increases.</p>

<p>For example, consider this scalding job:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">class</span> <span class="nc">ComplicatedJob</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Args</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Job</span><span class="o">(</span><span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">bloatedTsv</span> <span class="k">=</span> <span class="nc">Tsv</span><span class="o">(</span><span class="s">&quot;input&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="o">(</span><span class="-Symbol">&#39;user_id</span><span class="o">,</span>
</span><span class='line'>      <span class="-Symbol">&#39;timestamp</span><span class="o">,</span>
</span><span class='line'>      <span class="-Symbol">&#39;host</span><span class="o">,</span>
</span><span class='line'>      <span class="-Symbol">&#39;referer</span><span class="o">,</span>
</span><span class='line'>      <span class="-Symbol">&#39;remote_addr</span><span class="o">,</span>
</span><span class='line'>      <span class="-Symbol">&#39;user_agent</span><span class="o">,</span>
</span><span class='line'>      <span class="-Symbol">&#39;cookie</span><span class="o">,</span>
</span><span class='line'>      <span class="-Symbol">&#39;connection</span><span class="o">,</span>
</span><span class='line'>      <span class="-Symbol">&#39;accept_encoding</span><span class="o">,</span>
</span><span class='line'>      <span class="-Symbol">&#39;accept_language</span><span class="o">)).</span><span class="n">read</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">bloatedTsv</span>
</span><span class='line'>    <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="-Symbol">&#39;timestamp</span> <span class="o">-&gt;</span> <span class="-Symbol">&#39;timestamp</span><span class="o">)</span> <span class="o">{</span> <span class="n">ts</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="n">toDateTime</span><span class="o">(</span><span class="n">ts</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="-Symbol">&#39;timestamp</span><span class="o">)</span> <span class="o">{</span> <span class="n">ts</span><span class="k">:</span> <span class="kt">DateTime</span> <span class="o">=&gt;</span> <span class="n">ts</span><span class="o">.</span><span class="n">isAfter</span><span class="o">(</span><span class="nc">DateTime</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">minusDays</span><span class="o">(</span><span class="mi">30</span><span class="o">))</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="-Symbol">&#39;user_agent</span> <span class="o">-&gt;</span> <span class="-Symbol">&#39;browser</span><span class="o">)</span> <span class="o">{</span> <span class="n">userAgent</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="n">toBrowser</span><span class="o">(</span><span class="n">userAgent</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="-Symbol">&#39;remote_addr</span> <span class="o">-&gt;</span> <span class="-Symbol">&#39;country</span><span class="o">)</span> <span class="o">{</span> <span class="n">ip</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="n">toCountry</span><span class="o">(</span><span class="n">ip</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="-Symbol">&#39;country</span> <span class="o">-&gt;</span> <span class="-Symbol">&#39;country</span><span class="o">)</span> <span class="o">{</span> <span class="n">c</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="s">&quot;us&quot;</span><span class="o">)</span> <span class="n">c</span> <span class="k">else</span> <span class="s">&quot;other&quot;</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="-Symbol">&#39;browser</span><span class="o">,</span> <span class="-Symbol">&#39;country</span><span class="o">)</span> <span class="o">{</span> <span class="k">_</span><span class="o">.</span><span class="n">size</span><span class="o">(</span><span class="-Symbol">&#39;count</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="-Symbol">&#39;browser</span><span class="o">)</span> <span class="o">{</span> <span class="k">_</span><span class="o">.</span><span class="n">pivot</span><span class="o">((</span><span class="-Symbol">&#39;country</span><span class="o">,</span> <span class="-Symbol">&#39;count</span><span class="o">)</span> <span class="o">-&gt;(</span><span class="-Symbol">&#39;us</span><span class="o">,</span> <span class="-Symbol">&#39;other</span><span class="o">))</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">.</span><span class="n">write</span><span class="o">(</span><span class="nc">Tsv</span><span class="o">(</span><span class="s">&quot;output&quot;</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">toDateTime</span><span class="o">(</span><span class="n">ts</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">DateTime</span> <span class="o">=</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Testing this job end-to-end would be fragile because there is so much going on and it would be tedious and noisy to build fake data to isolate and highlight edge cases. The pivot operations on lines 20-22 only deal with <code>browser</code> and <code>country</code> yet test data with all 10 fields is required including valid timestamps and user agents just to get to the pivot logic.</p>

<p> There are a few ways to tackle this and an approach I like is to use extension methods to breakdown the logic into smaller chunks of testable code. The result might look something like this.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">class</span> <span class="nc">ComplicatedJob</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Args</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Job</span><span class="o">(</span><span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">bloatedTsv</span>
</span><span class='line'>    <span class="o">.</span><span class="n">timestampIsAfter</span><span class="o">(</span><span class="nc">DateTime</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">minusDays</span><span class="o">(</span><span class="mi">30</span><span class="o">))</span>
</span><span class='line'>    <span class="o">.</span><span class="n">userAgentToBrowser</span><span class="o">()</span>
</span><span class='line'>    <span class="o">.</span><span class="n">remoteAddrToCountry</span><span class="o">()</span>
</span><span class='line'>    <span class="o">.</span><span class="n">countCountryByBrowser</span><span class="o">()</span>
</span><span class='line'>    <span class="o">.</span><span class="n">write</span><span class="o">(</span><span class="nc">Tsv</span><span class="o">(</span><span class="s">&quot;output&quot;</span><span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Each block of code depends on only a few fields so it doesn&rsquo;t require mocking the entire input set.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">Dsl._</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">ComplicatedJob</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">class</span> <span class="nc">ComplicatedJobRichPipe</span><span class="o">(</span><span class="n">pipe</span><span class="k">:</span> <span class="kt">Pipe</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// this chunk of code is testable in isolation</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">countCountryByBrowser</span><span class="o">()</span><span class="k">:</span> <span class="kt">Pipe</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">pipe</span>
</span><span class='line'>        <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="-Symbol">&#39;country</span> <span class="o">-&gt;</span> <span class="-Symbol">&#39;country</span><span class="o">)</span> <span class="o">{</span> <span class="n">c</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=&gt;</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="s">&quot;us&quot;</span><span class="o">)</span> <span class="n">c</span> <span class="k">else</span> <span class="s">&quot;other&quot;</span> <span class="o">}</span>
</span><span class='line'>        <span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="-Symbol">&#39;browser</span><span class="o">,</span> <span class="-Symbol">&#39;country</span><span class="o">)</span> <span class="o">{</span> <span class="k">_</span><span class="o">.</span><span class="n">size</span><span class="o">(</span><span class="-Symbol">&#39;count</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>        <span class="o">.</span><span class="n">groupBy</span><span class="o">(</span><span class="-Symbol">&#39;browser</span><span class="o">)</span> <span class="o">{</span> <span class="k">_</span><span class="o">.</span><span class="n">pivot</span><span class="o">((</span><span class="-Symbol">&#39;country</span><span class="o">,</span> <span class="-Symbol">&#39;count</span><span class="o">)</span> <span class="o">-&gt;(</span><span class="-Symbol">&#39;us</span><span class="o">,</span> <span class="-Symbol">&#39;other</span><span class="o">))</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this example only <code>browser</code> and <code>country</code> are required so setting up test data is reasonably painless and the intent of the test case isn&rsquo;t lost in a sea of tuples. Granted, this approach requires creating a helper job to set up the input and capture the output for test assertions, but I think it&rsquo;s a worthwhile trade off to reveal such a clear test case.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">ComplicatedJob._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">ComplicatedJobTests._</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@RunWith</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">JUnitRunner</span><span class="o">])</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ComplicatedJobTests</span> <span class="k">extends</span> <span class="nc">FunSuite</span> <span class="k">with</span> <span class="nc">ShouldMatchers</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">test</span><span class="o">(</span><span class="s">&quot;should count and pivot rows into columns&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">input</span> <span class="k">=</span> <span class="nc">List</span><span class="o">[</span><span class="kt">InputTuple</span><span class="o">](</span>
</span><span class='line'>      <span class="o">(</span><span class="s">&quot;firefox&quot;</span><span class="o">,</span> <span class="s">&quot;us&quot;</span><span class="o">),</span>
</span><span class='line'>      <span class="o">(</span><span class="s">&quot;chrome&quot;</span><span class="o">,</span> <span class="s">&quot;us&quot;</span><span class="o">),</span>
</span><span class='line'>      <span class="o">(</span><span class="s">&quot;safari&quot;</span><span class="o">,</span> <span class="s">&quot;us&quot;</span><span class="o">),</span>
</span><span class='line'>      <span class="o">(</span><span class="s">&quot;firefox&quot;</span><span class="o">,</span> <span class="s">&quot;us&quot;</span><span class="o">),</span>
</span><span class='line'>      <span class="o">(</span><span class="s">&quot;firefox&quot;</span><span class="o">,</span> <span class="s">&quot;br&quot;</span><span class="o">),</span>
</span><span class='line'>      <span class="o">(</span><span class="s">&quot;chrome&quot;</span><span class="o">,</span> <span class="s">&quot;de&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">expected</span> <span class="k">=</span> <span class="nc">Set</span><span class="o">[</span><span class="kt">OutputTuple</span><span class="o">](</span>
</span><span class='line'>      <span class="o">(</span><span class="s">&quot;firefox&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">1</span><span class="o">),</span>
</span><span class='line'>      <span class="o">(</span><span class="s">&quot;safari&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">0</span><span class="o">),</span>
</span><span class='line'>      <span class="o">(</span><span class="s">&quot;chrome&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">1</span><span class="o">)</span>
</span><span class='line'>    <span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">count</span><span class="o">(</span><span class="n">input</span><span class="o">)</span> <span class="o">{</span> <span class="k">_</span><span class="o">.</span><span class="n">toSet</span> <span class="n">should</span> <span class="n">equal</span><span class="o">(</span><span class="n">expected</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">ComplicatedJobTests</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">type</span> <span class="kt">InputTuple</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">,</span> <span class="nc">String</span><span class="o">)</span>
</span><span class='line'>  <span class="k">type</span> <span class="kt">OutputTuple</span> <span class="o">=</span> <span class="o">(</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Int</span><span class="o">,</span> <span class="nc">Int</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// this is a helper job to set up the inputs and outputs</span>
</span><span class='line'>  <span class="c1">// for the chunk of code we&#39;re trying to test</span>
</span><span class='line'>  <span class="k">class</span> <span class="nc">CountCountryByBrowser</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">Args</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Job</span><span class="o">(</span><span class="n">args</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nc">Tsv</span><span class="o">(</span><span class="s">&quot;input&quot;</span><span class="o">,</span> <span class="o">(</span><span class="-Symbol">&#39;browser</span><span class="o">,</span> <span class="-Symbol">&#39;country</span><span class="o">))</span>
</span><span class='line'>      <span class="o">.</span><span class="n">read</span>
</span><span class='line'>      <span class="o">.</span><span class="n">countCountryByBrowser</span><span class="o">()</span> <span class="c1">// this is what we&#39;re testing</span>
</span><span class='line'>      <span class="o">.</span><span class="n">project</span><span class="o">(</span><span class="-Symbol">&#39;browser</span><span class="o">,</span> <span class="-Symbol">&#39;us</span><span class="o">,</span> <span class="-Symbol">&#39;other</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">write</span><span class="o">(</span><span class="nc">Tsv</span><span class="o">(</span><span class="s">&quot;output&quot;</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// helper method to run our test job</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">count</span><span class="o">(</span><span class="n">input</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">InputTuple</span><span class="o">])(</span><span class="n">fn</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">OutputTuple</span><span class="o">]</span> <span class="k">=&gt;</span> <span class="nc">Unit</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">import</span> <span class="nn">Dsl._</span>
</span><span class='line'>    <span class="nc">JobTest</span><span class="o">[</span><span class="kt">CountCountryByBrowser</span><span class="o">]</span>
</span><span class='line'>      <span class="o">.</span><span class="n">source</span><span class="o">(</span><span class="nc">Tsv</span><span class="o">(</span><span class="s">&quot;input&quot;</span><span class="o">,</span> <span class="o">(</span><span class="-Symbol">&#39;browser</span><span class="o">,</span> <span class="-Symbol">&#39;country</span><span class="o">)),</span> <span class="n">input</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">sink</span><span class="o">[</span><span class="kt">OutputTuple</span><span class="o">](</span><span class="nc">Tsv</span><span class="o">(</span><span class="s">&quot;output&quot;</span><span class="o">))</span> <span class="o">{</span> <span class="n">b</span> <span class="k">=&gt;</span> <span class="n">fn</span><span class="o">(</span><span class="n">b</span><span class="o">.</span><span class="n">toList</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>      <span class="o">.</span><span class="n">run</span>
</span><span class='line'>      <span class="o">.</span><span class="n">finish</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/parsing-json-with-defaults-in-scala/">Parsing Json With Defaults in Scala</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-01-24T22:57:00-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>24</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>10:57 pm</span></time>
        
           | <a href="/parsing-json-with-defaults-in-scala/#disqus_thread"
             data-disqus-identifier="http://www.mikevalenty.com/parsing-json-with-defaults-in-scala/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The <a href="http://www.playframework.com/documentation/2.2.x/ScalaJson">json library in Play</a> does this thing where it explodes if the json you&rsquo;re reading is missing a property. <a href="https://code.google.com/p/google-gson/">Gson</a> would happily leave the property null, but that&rsquo;s just not the scala way. In scala, if something is optional, it&rsquo;s wrapped in an <code>Option</code>. The problem is I&rsquo;d like to add a property to my data model and I don&rsquo;t want it to be optional because it&rsquo;s not.</p>

<p>In Java land, I probably would have added the property and thought about how to deal with migrating old data later, but not in scala. This battle has to be fought right now. That&rsquo;s what <em>type safe</em> means and it&rsquo;s why the <code>NullPointerException</code> has all but died in pure scala apps, not unlike the <a href="http://freakonomics.com/2013/09/12/whatever-happened-to-the-carpal-tunnel-epidemic/">carpal tunnel epidemic</a>.</p>

<p>In my case I&rsquo;ve got some data in Couchbase and when I add a new property to my data model, I won&rsquo;t be able to read the old data. What I need to do is transform the json before hydrating the object. Fortunately, this is a snap by using the rich transformation features described in <a href="http://mandubian.com/2013/01/13/JSON-Coast-to-Coast/">JSON Coast-to-Coast</a>.</p>

<p>My approach was to create a subclass of <code>Reads[A]</code> called <code>ReadsWithDefaults[A]</code> that reads json and uses a transformation to merge default values. It looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">MyObject</span><span class="o">(</span><span class="n">color</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">shape</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">MyObject</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">defaults</span> <span class="k">=</span> <span class="nc">MyObject</span><span class="o">(</span><span class="s">&quot;blue&quot;</span><span class="o">,</span> <span class="s">&quot;square&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">implicit</span> <span class="k">val</span> <span class="n">readsMyObject</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ReadsWithDefaults</span><span class="o">(</span><span class="n">defaults</span><span class="o">)(</span><span class="nc">Json</span><span class="o">.</span><span class="n">format</span><span class="o">[</span><span class="kt">MyObject</span><span class="o">])</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">implicit</span> <span class="k">val</span> <span class="n">writesMyObject</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Json</span><span class="o">.</span><span class="n">writes</span><span class="o">[</span><span class="kt">MyObject</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.Reads._</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ReadsWithDefaults</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">defaults</span><span class="k">:</span> <span class="kt">A</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">format</span><span class="k">:</span> <span class="kt">Format</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Reads</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">private</span> <span class="k">val</span> <span class="n">mergeWithDefaults</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">defaultJson</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">fromJson</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">](</span><span class="nc">Json</span><span class="o">.</span><span class="n">toJson</span><span class="o">(</span><span class="n">defaults</span><span class="o">)).</span><span class="n">get</span>
</span><span class='line'>    <span class="nc">__</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="n">of</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span> <span class="n">map</span> <span class="o">{</span><span class="n">o</span> <span class="k">=&gt;</span> <span class="n">defaultJson</span> <span class="o">++</span> <span class="n">o</span><span class="o">})</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">reads</span><span class="o">(</span><span class="n">json</span><span class="k">:</span> <span class="kt">JsValue</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">jsObject</span> <span class="k">=</span> <span class="n">json</span><span class="o">.</span><span class="n">transform</span><span class="o">(</span><span class="n">mergeWithDefaults</span><span class="o">).</span><span class="n">get</span>
</span><span class='line'>    <span class="nc">Json</span><span class="o">.</span><span class="n">fromJson</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">jsObject</span><span class="o">)(</span><span class="n">format</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/web-framework-scaffolding-considered-harmful/">Web Framework Scaffolding Considered Harmful</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2014-01-02T09:59:00-08:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2014</span></span> <span class='time'>9:59 am</span></time>
        
           | <a href="/web-framework-scaffolding-considered-harmful/#disqus_thread"
             data-disqus-identifier="http://www.mikevalenty.com/web-framework-scaffolding-considered-harmful/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you&rsquo;re a start up and spending time building back office tools to input application data into web forms, you&rsquo;re doing it wrong. Sure, it&rsquo;s a pretty simple task to build a few <a href="http://en.wikipedia.org/wiki/Create,_read,_update_and_delete">CRUD</a> screens using the hottest new MVC framework, but you can do better.</p>

<p>Integrating with Google spreadsheets to manage application data unlocks powerful possibilities and will take you further than anything you could scaffold up in a comperable amount of time. To be clear, I&rsquo;m not suggesting you take a <em>runtime</em> dependency on Google docs. I&rsquo;m talking about using a lightweight business process that takes advantage of the rich collaborations features of Google docs and simply <em>import</em> the data into your database using the <a href="https://developers.google.com/google-apps/spreadsheets/">API</a>.</p>

<p><img src="/images/posts/example_sp3.png" width="600"></p>

<div style="clear:both;"></div>


<h3>Revision history</h3>

<p><img class="right" src="/images/posts/example_rev.png" width="300"></p>

<p>Google docs keeps a revision history of what was changed, when and by whom. That&rsquo;s a pretty cool feature and one you&rsquo;re not likely to build when there are more pressing customer facing features to work on.</p>

<p>Sometimes release notes aren&rsquo;t detailed enough when trying to correlate a surprising change in a KPI, so it&rsquo;s reassuring to have the nitty gritty revision history there when you need to dig a little deeper. It&rsquo;s just like reviewing source control history when tracking down a bug that was introduced in the latest code release. Your data deserves the same respect.</p>

<h3>Concurrent editing</h3>

<p>My older brother carries a pocket knife at all times, and when he believes in something, he can&rsquo;t help but sell everyone else on the idea. He used to tell me I needed to carry a pocket knife so I could cut off my seatbelt when trapped in a burning (or sinking) car. In his defense, <a href="http://money.cnn.com/2010/08/17/autos/gm_recall/index.htm">GM recalled 240,000 SUVs in 2010</a> citing &ldquo;&hellip;[the seat belt] may seem to be jammed.&rdquo;</p>

<p>Naturally, I started carrying a pocket knife too. I figured that along with untrapping myself from a burning car or defending myself at an ATM, it would be handy when I needed to open a box. To my surprise, new opportunities presented themselves and I was using my knife several times a day. I could cut off a hanging thread, scrape bee pollen off my windsheild, improve the vent in my coffee lid, remove a scratchy tag from my son&rsquo;s shirt and yes, open a box.</p>

<p>It turns out I had a similar experience with concurrent editing. Working on the same document at the same time with multiple people is pretty cool, and you&rsquo;d be surprised how this powerful ability can change the way you work. There&rsquo;s no way you would justify an extravagant feature like this in your own back office tools and you get it for free with Google docs.</p>

<h3>Formulas</h3>

<p>Since it&rsquo;s a spreadsheet, you can use formulas and this is cooler than you might think. Consider a list of products. Chances are the product prices have some kind of relationship that you can capture with a formula and save yourself from tedious and error prone manual entry.</p>

<p>In reality though, you probably don&rsquo;t care about the actual product prices as much as you care about your margins or some other derived number. With a spreadsheet, you can keep your formula together with your data. When you change a price, you can see how it affects your bottom line in a calculated field a few cells over. Or work backwards and calculate the price based on a combination of other factors. Or just use a forumla as a sanity check that all your numbers add up to the right amount.</p>

<p>Again, this is the kind of feature that invites new ways of working. You might use a formula to find a bug before the data ever hits your app or add a new forumla so you don&rsquo;t get burned twice by the same mistake. A spreadsheet gives you a place to capture knowledge about your data. You could capture this knowledge in a wiki, but the fact that it&rsquo;s in a Google spreadsheet that&rsquo;s connected to your app, makes it real. It&rsquo;s the difference between a code comment and a unit test.</p>

<h3>Import</h3>

<p><img class="right" src="/images/posts/example_dup.png" width="300"></p>

<p>A data update is a deployment just like a code deployment and things can go horribly wrong when there&rsquo;s a mistake in your data. Big companies get this and respond with change advisory boards and more process to protect themselves, but you can do better.</p>

<p>Your data deserves a repeatable one-click deployment process and you shouldn&rsquo;t settle for anything less. An import is <a href="http://en.wikipedia.org/wiki/Idempotence">idempotent</a> which means you can run it multiple times and the end result is always the same. In other words, you can practice in a test environment and iterate until you get it right. Oh, and if you spin off a copy prior to making changes, you get one-click rollback too.</p>

<h2>Conclusion</h2>

<p>One-click deployment and rollback with revision history for your data without developer interaction. That&rsquo;s a really big deal because the end result is confidence. Confidence means that as an organization, you can make decisions, execute and not look back.</p>

<p>Empower your team (not just developers) with a familiar tool like a spreadsheet and give them the opportunity to impress you. Watch as calculations and charts emerge to add deeper meaning to your data. Watch as collaboration occurs and team members are brought together rather than divided by functional roles. Watch as confidence increases in your ability to deploy changes.</p>

<p>Seriously. Don&rsquo;t waste your time half-assing back office tools when you can invest a similar amount of effort to import data from Google spreadsheets. It&rsquo;s a scrappy tool that delivers on the features that accelerate the way you work.</p>

<div style="clear:both;"></div>


<blockquote><p>If you can do a half-assed job of anything, you’re a one-eyed man in a kingdom of the blind. – Kurt Vonnegut</p></blockquote>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/scala-solution-to-finding-happy-numbers/">Scala Solution to Finding Happy Numbers</a>
      </li>
    
      <li class="post">
        <a href="/scala-solution-to-cheryls-birthday-problem/">Scala Solution to Cheryl&#8217;s Birthday Problem</a>
      </li>
    
      <li class="post">
        <a href="/unit-testing-scalding-jobs/">Unit Testing Scalding Jobs</a>
      </li>
    
      <li class="post">
        <a href="/parsing-json-with-defaults-in-scala/">Parsing Json With Defaults in Scala</a>
      </li>
    
      <li class="post">
        <a href="/web-framework-scaffolding-considered-harmful/">Web Framework Scaffolding Considered Harmful</a>
      </li>
    
      <li class="post">
        <a href="/using-scala-to-perform-a-multi-key-get-on-a-couchbase-view/">Using Scala to Perform a Multi-Key Get on a Couchbase View</a>
      </li>
    
      <li class="post">
        <a href="/hadoop-mapreduce-join-optimization-with-a-bloom-filter/">Hadoop MapReduce Join Optimization With a Bloom Filter</a>
      </li>
    
      <li class="post">
        <a href="/extracting-root-domain-from-a-url/">Extracting Root Domain From a Url</a>
      </li>
    
  </ul>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Mike Valenty -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'agileatwork';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
